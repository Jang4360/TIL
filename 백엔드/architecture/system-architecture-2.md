# 처리율 제한 장치의 설계
## 1. 처리율 제한 장치

처리율 제한 장치는 클라이언트 또는 서비스가 보내는 트래픽의 처리율을 제어하기 위한 장치이다.

이는 특정 기간 내에 전송되는 클라이언트의 요청 횟수를 제한한다.

따라서 API 요청 횟수가 제한 장치에 정의된 임계치를 넘어가면 추가로 도달한 호출은 처리가 중단된다.

### API 처리율 제한 장치 장점

- DoS(denial of service) 공격에 의한 자원 고갈을 방지할 수 있다
- 추가 요청에 대한 처리를 제한하면 서버를 많이 두지 않아도 되고 우선 순위가 높은 API에 더 많은 자원을 할 당 할 수 있어 비용을 절감한다
- 봇에서 오는 트래픽이나 사용자의 악의적인 트래픽을 걸러내어 서버 과부하를 막아낼 수 있다

---

## 2. 설계안

### 1) 요구사항

- 설정된 처리율을 초과하는 요청은 정확하게 제한한다
- 가능한 한 적은 메모리를 사용해야 한다
- 하나의 처리율 제한 장치를 여러 서버나 프로세스에서 공유할 수 있어야 한다
- 요청이 제한되었을 때는 그 사실을 사용자에게 분명히 알려줘야 한다
- 제한 장치에 장애가 생기더라도 전체 시스템에 영향을 주어서는 안 된다

### 2) 계략적인 설계안 제시 및 동의 구하기

**처리율 제한 장치는 어디에 둘 것인지?**

- 클라이언트 측: 클라이언트 요청은 쉽게 위변조가 가능하고 모든 클라이언트의 구현을 통제하는 것도 어려울 수 있다
- 서버측
- 미들웨어

클라우드 마이크로서비스는 보통 API 게이트웨이에 처리율 제한 장치가 구현된다.

API 게이트웨이는 처리율 제한, SSL 종단, 사용자 인증, IP 허용 목록 관리등 클라우드 업체에서 유지 보수를 해주는 서비스이다.

**지침 사항**

- 프로그래밍 언어, 캐시 서비스 등 현재 사용하는 기술 스택을 확인해 서버 측 구현을 지원하기 충분할 정도로 효율이 높은지 확인하기
- 서버측에서 구현하기로 했다면 처리율 제한 알고리즘을 자유롭게 선택 가능, 반면 제 3 사업자가 제공하는 게이트웨이를 사용하기로 했다면 선택지는 제한 될 수 있다
- 현재 설계가 마이크로서비스에 기반하고 있고 사용자 인증이나 IP 허용목록 관리 등을 처리하기 위해 API 게이트웨이를 사용하고 있다면 처리율 제한 기능 또한 게이트웨이에 포함시키면 좋을 것이다

**처리율 제한 알고리즘**

- 토큰 버킷 알고리즘
    - 토큰 버킷은 지정된 용량을 갖는 컨테이너로 사전 설정된 양의 토큰이 주기적으로 채워진다
    - 충분한 토큰이 있다면 버킷에서 토큰 하나를 꺼내 요청을 전달한다
    - 충분한 토큰이 없다면 해당 요청을 버린다
- 누출 버킷 알고리즘
    - 토큰 버킷 알고리즘과 비슷하지만 요청 처리율이 고정되어 있다
- 고정 윈도 카운터 알고리즘
    - 타임라인을 고정된 간격의 윈도로 나누고 각 윈도마다 카운터를 붙여 요청이 접수될 때마다 이 카운터의 값은 1씩 증가한다
    - 카운터의 값이 사전에 설정된 임계치에 도달하면 새로운 요청은 윈도가 열릴 때까지 버려진다
    - 윈도의 경계 부분에 순간적으로 많은 트래픽이 집중되면 윈도에 할당된 양보다 더 많은 요청이 처리될 수 있다
- 이동 윈도 로깅 알고리즘
    - 요청의 타임스탬프를 추적하고 타임스탬프 데이터는 보통 레디스의 정렬 집합 같은 캐시에 보관한다
    - 새 요청의 타임스탬프를 로그에 추가하고 로그의 크기가 허용치보다 같거나 작으면 요청을 시스템에 전달하고 그렇지 않으면 처리를 거부한다
- 이동 윈도 카운터 알고리즘
    - 고정 윈도 카운터와 윈도 로깅 알고리즘을 결합한 것이다
    - 이전 시간대의 평균 처리율에 따라 현재 윈도의 상태를 계산하기에 짧은 시간에 몰리는 트래픽에도 잘 대응한다

**계략적인 아키텍처**

- 얼마나 많은 요청이 들어왔는지를 추적할 수 있는 카운터를 추적 대상별로 두기 (사용자 별 / IP 주소별 / API 엔드포인트나 서비스 단위)
- 카운트의 값이 어떤 임계치를 넘어서 도착한 요청은 거부한다
- 카운터 보관은 메모리상에 동작하는 캐시가 빠른데다 시간에 기반한 만료정책을 지원하기에 적합하다

### 3) 상세 설계

- 처리율 제한 규칙: 설정 파일 형태로 디스크에 저장된다
- 처리율 한도 초과 트래픽 처리: 요청이 한도 제한에 걸리면 HTTP 429 응답을 클라이언트로 보낸다

<img width="578" height="487" alt="Image" src="https://github.com/user-attachments/assets/d2f5833d-941b-468a-b9b9-a758826605fe" />

- 클라이언트가 요청을 서버에 보내면 요청은 먼저 처리율 제한 미들웨어에 도달한다
- 처리율 제한 미들웨어는 제한 규칙을 캐시에서 가져온다. 그리고 카운터 및 마지막 요청의 타임스탬프를 레디스 캐시에서 가져온다. 가져온 값들을 기반으로 미들웨어는 결정을 내린다
    - 요청이 처리율 제한에 걸리지 않은 경우 → API 서버로 보낸다
    - 요청이 처리율 제한에 걸린 경우 → 429 에러를 클라이언트로 보낸다 (요청을 버리기 / 메시지 큐에 보관하기)
    

**분산환경에서의 처리율 제한 장치 구현**

- 경쟁 조건
    - 락 → 시스템 성능을 떨어뜨림
    - 루아 스크립트, 레디스의 정렬 집합
- 동기화
    - sticky session 사용해서 같은 클라이언트는 항상 같은 처리율 제한장치로 보내기 → 확장 가능 x, 유연 x
    - 레디스 같은 중앙 집중형 데이터 저장소 사용하기
